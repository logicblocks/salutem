<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>salutem.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Salutem</span> <span class="project-version">0.1.0</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="getting-started.html"><div class="inner"><span>Getting Started</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>salutem</span></div></div></li><li class="depth-2 current"><a href="salutem.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="salutem.core.checks.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checks</span></div></a></li><li class="depth-3 branch"><a href="salutem.core.maintenance.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>maintenance</span></div></a></li><li class="depth-3 branch"><a href="salutem.core.registry.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>registry</span></div></a></li><li class="depth-3 branch"><a href="salutem.core.results.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>results</span></div></a></li><li class="depth-3"><a href="salutem.core.time.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>time</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="salutem.core.html#var-all-checks"><div class="inner"><span>all-checks</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-background-check"><div class="inner"><span>background-check</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-background.3F"><div class="inner"><span>background?</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-check-names"><div class="inner"><span>check-names</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-duration"><div class="inner"><span>duration</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-empty-registry"><div class="inner"><span>empty-registry</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-evaluate"><div class="inner"><span>evaluate</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-find-cached-result"><div class="inner"><span>find-cached-result</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-find-check"><div class="inner"><span>find-check</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-healthy"><div class="inner"><span>healthy</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-healthy.3F"><div class="inner"><span>healthy?</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-maintain"><div class="inner"><span>maintain</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-outdated-checks"><div class="inner"><span>outdated-checks</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-outdated.3F"><div class="inner"><span>outdated?</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-realtime-check"><div class="inner"><span>realtime-check</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-realtime.3F"><div class="inner"><span>realtime?</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-resolve-check"><div class="inner"><span>resolve-check</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-resolve-checks"><div class="inner"><span>resolve-checks</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-result"><div class="inner"><span>result</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-shutdown"><div class="inner"><span>shutdown</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-unhealthy"><div class="inner"><span>unhealthy</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-unhealthy.3F"><div class="inner"><span>unhealthy?</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-with-cached-result"><div class="inner"><span>with-cached-result</span></div></a></li><li class="depth-1"><a href="salutem.core.html#var-with-check"><div class="inner"><span>with-check</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">salutem.core</h1><div class="doc"><div class="markdown"><p>A system for defining and maintaining a collection of health checks with support for both realtime and background checks.</p>
<p>The <code>salutem.core</code> namespace is the public interface of the system and should be used in preference of the contained namespaces.</p>
<p><code>salutem</code> is somewhat inspired by <a href="https://github.com/dropwizard/dropwizard-health">dropwizard-health</a> which may provide additional insight into its design.</p></div></div><div class="public anchor" id="var-all-checks"><h3>all-checks</h3><div class="usage"><code>(all-checks registry)</code></div><div class="doc"><div class="markdown"><p>Returns the set of checks present in the registry.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L202">view source</a></div></div><div class="public anchor" id="var-background-check"><h3>background-check</h3><div class="usage"><code>(background-check check-name check-fn)</code><code>(background-check check-name check-fn opts)</code></div><div class="doc"><div class="markdown"><p>Constructs a background check with the provided name and check function.</p>
<p>A background check is one that is evaluated periodically with the result cached until the next evaluation, which will occur once the time-to-live (TTL) of the check has passed.</p>
<p>Background checks are useful for external dependencies where it is important not to perform the check too frequently and where the health status only needs to be accurate to within the TTL.</p>
<p>Takes the following parameters:</p>
<ul>
  <li><code>check-name</code>: a keyword representing the name of the check</li>
  <li><code>check-fn</code>: an arity-2 function, with with the first argument being a context map as provided during evaluation or at maintenance pipeline construction and the second argument being a callback function which should be called with the result fo the check to signal the check is complete; note, check functions <em>must</em> be non-blocking.</li>
  <li><code>opts</code>: an optional map of additional options for the check, containing:
    <ul>
      <li><code>:ttl</code>: a <a href="salutem.core.html#var-duration">duration</a> representing the TTL for a result of this check,  defaulting to 10 seconds</li>
      <li><code>:timeout</code>: a <a href="salutem.core.html#var-duration">duration</a> representing the amount of time to wait for  the check to complete before considering it failed, defaulting to  10 seconds</li>
    </ul>
  </li>
</ul></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L92">view source</a></div></div><div class="public anchor" id="var-background.3F"><h3>background?</h3><div class="usage"><code>(background? check)</code></div><div class="doc"><div class="markdown"><p>Returns <code>true</code> if the provided check is a background check, <code>false</code> otherwise.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L146">view source</a></div></div><div class="public anchor" id="var-check-names"><h3>check-names</h3><div class="usage"><code>(check-names registry)</code></div><div class="doc"><div class="markdown"><p>Returns the set of check names present in the registry.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L197">view source</a></div></div><div class="public anchor" id="var-duration"><h3>duration</h3><div class="usage"><code>(duration amount unit)</code></div><div class="doc"><div class="markdown"><p>Constructs an object representing a duration of time.</p>
<p>This object is used to specify, for example, the time-to-live (TTL) and timeout on a check or the interval passed to a maintenance pipeline.</p>
<p>Takes an amount and a unit:</p>
<ul>
  <li><code>amount</code> is the length of the duration, measured in terms of the unit</li>
  <li><code>unit</code> is one of <code>:nanos</code>, <code>:micros</code>, <code>:millis</code>, <code>:seconds</code>, <code>:minutes</code>, <code>:hours</code>, <code>:half-days</code>, <code>:days</code>, <code>:weeks</code>, <code>:months</code>, <code>:years</code>, <code>:decades</code>, <code>:centuries</code>, <code>:millennia</code>, <code>:eras</code> or <code>:forever</code></li>
</ul>
<p>Note: internally, this constructs a <code>java.time.Duration</code> and is merely a convenience function. As such, a <code>java.time.Duration</code> can be passed directly wherever this function would be used.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L18">view source</a></div></div><div class="public anchor" id="var-empty-registry"><h3>empty-registry</h3><div class="usage"><code>(empty-registry)</code></div><div class="doc"><div class="markdown"><p>Constructs an empty registry which can be populated using <a href="salutem.core.html#var-with-check">with-check</a> and <a href="salutem.core.html#var-with-cached-result">with-cached-result</a>.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L169">view source</a></div></div><div class="public anchor" id="var-evaluate"><h3>evaluate</h3><div class="usage"><code>(evaluate check)</code><code>(evaluate check context)</code></div><div class="doc"><div class="markdown"><p>Evaluates the provided check synchronously, returning the result of the evaluation.</p>
<p>Optionally takes a context map containing arbitrary context required by the check in order to run and passed to the check function as the first argument.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L158">view source</a></div></div><div class="public anchor" id="var-find-cached-result"><h3>find-cached-result</h3><div class="usage"><code>(find-cached-result registry check-name)</code></div><div class="doc"><div class="markdown"><p>Finds the cached result for the check with the given name in the registry. Returns <code>nil</code> if no result can be found or if the check does not exist.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L191">view source</a></div></div><div class="public anchor" id="var-find-check"><h3>find-check</h3><div class="usage"><code>(find-check registry check-name)</code></div><div class="doc"><div class="markdown"><p>Finds the check with the given name in the registry. Returns <code>nil</code> if no check can be found.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L185">view source</a></div></div><div class="public anchor" id="var-healthy"><h3>healthy</h3><div class="usage"><code>(healthy)</code><code>(healthy extra-data)</code></div><div class="doc"><div class="markdown"><p>Constructs a healthy result.</p>
<p>The optional map of extra data is stored with the result for future use. Unless overridden in the extra data map, an <code>:evaluated-at</code> field is added to the result, set to the current date time in the system default time zone.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L47">view source</a></div></div><div class="public anchor" id="var-healthy.3F"><h3>healthy?</h3><div class="usage"><code>(healthy? result)</code></div><div class="doc"><div class="markdown"><p>Returns <code>true</code> if the result has a <code>:healthy</code> status, <code>false</code> otherwise.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L65">view source</a></div></div><div class="public anchor" id="var-maintain"><h3>maintain</h3><div class="usage"><code>(maintain registry-store)</code><code>(maintain registry-store options)</code></div><div class="doc"><div class="markdown"><p>Constructs and starts a maintenance pipeline to maintain up-to-date results for the checks in the registry in the provided registry store atom.</p>
<p>The maintenance pipeline consists of a number of independent processes:</p>
<ul>
  <li>a <em>maintainer</em> which triggers an attempt to refresh the results periodically,</li>
  <li>a <em>refresher</em> which requests evaluation of each outdated check on each refresh attempt,</li>
  <li>an <em>evaluator</em> which evaluates outdated checks to obtain a fresh result,</li>
  <li>an <em>updater</em> which updates the registry store atom with fresh check results,</li>
  <li>a <em>notifier</em> which calls callback functions when fresh check results are available.</li>
</ul>
<p>The maintenance pipeline can be configured via an optional map which can contain the following options:</p>
<ul>
  <li><code>:context</code>: a map containing arbitrary context required by checks in order to run and passed to the check functions as the first argument; defaults to an empty map</li>
  <li><code>:interval</code>: a <a href="salutem.core.html#var-duration">duration</a> describing the wait interval between attempts to refresh the results in the registry; defaults to 200 milliseconds</li>
  <li><code>:notification-callback-fns</code>: a sequence of arity-2 functions, with the first argument being a check and the second argument being a result, which are called whenever a new result is available for a check; empty by default</li>
  <li><code>:trigger-channel</code>: the channel on which trigger messages are sent, to indicate that a refresh of the registry should be attempted, defaults to a channel with a sliding buffer of length 1, i.e., in the case of a long running attempt, all but the latest trigger message will be dropped from the channel</li>
  <li><code>:evaluation-channel</code>: the channel on which messages requesting evaluation of checks are sent, defaults to a channel with a buffer of size 10</li>
  <li><code>:result-channel</code>: the channel on which results are placed after evaluation, defaults to a channel with a buffer of size 10</li>
  <li><code>:updater-result-channel</code>: a tap of the <code>result-channel</code> which sends result messages on to the updater, defaults to a channel with a buffer of size 10</li>
  <li><code>:notifier-result-channel</code>: a tap of the <code>result-channel</code> which sends result messages on to the notifier, defaults to a channel with a buffer of size 10</li>
</ul>
<p>If the context map contains a <code>:logger</code> key with a <a href="https://logicblocks.github.io/cartus/cartus.core.html#var-Logger"><code>cartus.core/Logger</code></a> value, the maintenance pipeline will emit a number of log events throughout operation.</p>
<p>Returns the maintenance pipeline which can be passed to <a href="salutem.core.html#var-shutdown">shutdown</a> in order to stop operation.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L246">view source</a></div></div><div class="public anchor" id="var-outdated-checks"><h3>outdated-checks</h3><div class="usage"><code>(outdated-checks registry)</code></div><div class="doc"><div class="markdown"><p>Returns the set of checks that are currently outdated in the registry based on the type of the check and the cached results available.</p>
<p>See <a href="salutem.core.html#var-outdated.3F">outdated?</a> for details on which it means for a check to be outdated.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L207">view source</a></div></div><div class="public anchor" id="var-outdated.3F"><h3>outdated?</h3><div class="usage"><code>(outdated? result check)</code><code>(outdated? result check relative-to)</code></div><div class="doc"><div class="markdown"><p>Returns <code>true</code> if the result of the check is outdated, <code>false</code> otherwise.</p>
<p>A result is considered outdated if its time-to-live (TTL) has expired, i.e., if its evaluation date time is before the current date time minus the TTL. If <code>relative-to</code> is provided, the calculation is performed relative to that date time rather than to the current date time.</p>
<p>Note: the result of a realtime check is always considered outdated.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L77">view source</a></div></div><div class="public anchor" id="var-realtime-check"><h3>realtime-check</h3><div class="usage"><code>(realtime-check check-name check-fn)</code><code>(realtime-check check-name check-fn opts)</code></div><div class="doc"><div class="markdown"><p>Constructs a realtime check with the provided name and check function.</p>
<p>A realtime check is one that is re-evaluated whenever the check is resolved, with no caching of results taking place.</p>
<p>Realtime checks are useful when the accuracy of the check needs to be very accurate or where the check itself is inexpensive.</p>
<p>Takes the following parameters:</p>
<ul>
  <li><code>check-name</code>: a keyword representing the name of the check</li>
  <li><code>check-fn</code>: an arity-2 function, with with the first argument being a context map as provided during evaluation or at maintenance pipeline construction and the second argument being a callback function which should be called with the result fo the check to signal the check is complete; note, check functions <em>must</em> be non-blocking.</li>
  <li><code>opts</code>: an optional map of additional options for the check, containing:
    <ul>
      <li><code>:timeout</code>: a <a href="salutem.core.html#var-duration">duration</a> representing the amount of time to wait for  the check to complete before considering it failed, defaulting to  10 seconds</li>
    </ul>
  </li>
</ul></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L121">view source</a></div></div><div class="public anchor" id="var-realtime.3F"><h3>realtime?</h3><div class="usage"><code>(realtime? check)</code></div><div class="doc"><div class="markdown"><p>Returns <code>true</code> if the provided check is a realtime check, <code>false</code> otherwise.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L152">view source</a></div></div><div class="public anchor" id="var-resolve-check"><h3>resolve-check</h3><div class="usage"><code>(resolve-check registry check-name)</code><code>(resolve-check registry check-name context)</code></div><div class="doc"><div class="markdown"><p>Resolves a result for the check of the given name in the registry.</p>
<p>If the check is a background check and there is a cached result available, it is returned. If no cached result is available, the check is evaluated in order to obtain a result to return.</p>
<p>If the check is a realtime check, it is always evaluated in order to obtain a result to return and caching is not used.</p>
<p>Optionally takes a context map containing arbitrary context required by the check in order to run and passed to the check function as the first argument.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L215">view source</a></div></div><div class="public anchor" id="var-resolve-checks"><h3>resolve-checks</h3><div class="usage"><code>(resolve-checks registry)</code><code>(resolve-checks registry context)</code></div><div class="doc"><div class="markdown"><p>Resolves all checks in the registry, returning a map of check names to results.</p>
<p>Optionally takes a context map containing arbitrary context required by checks in order to run and passed to the check functions as the first argument.</p>
<p>See <a href="salutem.core.html#var-resolve-check">resolve-check</a> for details on how each check is resolved.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L233">view source</a></div></div><div class="public anchor" id="var-result"><h3>result</h3><div class="usage"><code>(result status)</code><code>(result status extra-data)</code></div><div class="doc"><div class="markdown"><p>Constructs a result with the provided <code>status</code>.</p>
<p>The optional map of extra data is stored with the result for future use. Unless overridden in the extra data map, an <code>:evaluated-at</code> field is added to the result, set to the current date time in the system default time zone.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L38">view source</a></div></div><div class="public anchor" id="var-shutdown"><h3>shutdown</h3><div class="usage"><code>(shutdown maintenance-pipeline)</code></div><div class="doc"><div class="markdown"><p>Shuts down the maintenance pipeline preventing further updates to the registry.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L302">view source</a></div></div><div class="public anchor" id="var-unhealthy"><h3>unhealthy</h3><div class="usage"><code>(unhealthy)</code><code>(unhealthy extra-data)</code></div><div class="doc"><div class="markdown"><p>Constructs an unhealthy result.</p>
<p>The optional map of extra data is stored with the result for future use. Unless overridden in the extra data map, an <code>:evaluated-at</code> field is added to the result, set to the current date time in the system default time zone.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L56">view source</a></div></div><div class="public anchor" id="var-unhealthy.3F"><h3>unhealthy?</h3><div class="usage"><code>(unhealthy? result)</code></div><div class="doc"><div class="markdown"><p>Returns <code>true</code> if the result has an <code>:unhealthy</code> status, <code>false</code> otherwise.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L71">view source</a></div></div><div class="public anchor" id="var-with-cached-result"><h3>with-cached-result</h3><div class="usage"><code>(with-cached-result registry check result)</code></div><div class="doc"><div class="markdown"><p>Adds the result for the check to the registry, returning a new registry.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L180">view source</a></div></div><div class="public anchor" id="var-with-check"><h3>with-check</h3><div class="usage"><code>(with-check registry check)</code></div><div class="doc"><div class="markdown"><p>Adds the check to the registry, returning a new registry.</p></div></div><div class="src-link"><a href="https://github.com/logicblocks/salutem/blob/0.1.0/core/src/salutem/core.clj#L175">view source</a></div></div></div></body></html>